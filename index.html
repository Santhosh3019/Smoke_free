<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smoke-Free Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay, .sos-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content, .sos-content { transition: transform 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4A5568; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        canvas {
            background-color: #1E293B; /* slate-800 */
            border-radius: 0.75rem;
            cursor: crosshair;
        }
        .breathing-animation {
            transition: transform 4s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-gray-900 text-slate-200 antialiased">

    <!-- Main Container -->
    <div id="app-container" class="min-h-screen max-w-lg mx-auto p-4 flex flex-col fade-in">
        
        <!-- Header -->
        <header id="app-header" class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700/50">
            <h1 class="text-2xl font-bold text-cyan-400 tracking-wide" data-translate="appTitle">Smoke-Free Journey</h1>
            <div class="flex items-center space-x-2">
                <button id="next-day-button" class="hidden text-xs bg-purple-600 text-white px-2 py-1 rounded-full">Next Day</button>
                <button id="start-over-button" class="hidden text-xs text-slate-400 hover:text-white transition-colors" data-translate="startOverButton">Start Over</button>
                <button id="language-switcher" class="px-3 py-1 text-sm font-semibold bg-slate-800 rounded-full hover:bg-slate-700 transition-colors shadow-md">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
            </div>
        </header>

        <!-- Initial Setup Screen -->
        <div id="setup-screen" class="hidden flex-grow flex flex-col justify-center items-center text-center p-4">
             <div class="w-full bg-slate-800/50 p-8 rounded-2xl shadow-2xl">
                 <h2 class="text-3xl font-bold mb-2" data-translate="welcomeTitle">Welcome!</h2>
                 <p class="text-slate-400 mb-8" data-translate="welcomeSubtitle">Let's start your journey to a smoke-free life.</p>
                 <form id="setup-form" class="space-y-6">
                     <label for="initial-cigarettes" class="block text-lg font-medium mb-2" data-translate="initialCigarettesLabel">How many cigarettes do you smoke per day?</label>
                     <input type="number" id="initial-cigarettes" class="w-full bg-slate-900 border-2 border-slate-700 text-white text-center text-3xl rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" placeholder="e.g., 15" required min="1">
                     <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg shadow-cyan-500/20" data-translate="startButton">Start Journey</button>
                 </form>
             </div>
        </div>

        <!-- Main App Screen -->
        <div id="main-screen" class="hidden flex-grow flex flex-col">
            <!-- New Progress Card -->
             <div class="bg-slate-800/70 p-4 rounded-xl shadow-lg mb-6 text-center">
                <p class="text-sm text-slate-400" data-translate="overallProgress">Overall Progress</p>
                <div class="relative w-32 h-32 mx-auto mt-2">
                    <svg class="w-full h-full -rotate-90" viewBox="0 0 36 36">
                        <path class="text-slate-700" stroke-width="3" fill="none" stroke="currentColor" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                        <path id="progress-circle" class="text-cyan-400" stroke-width="3" fill="none" stroke="currentColor" stroke-linecap="round" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                    </svg>
                    <div id="progress-text" class="absolute inset-0 flex items-center justify-center text-2xl font-bold">0%</div>
                </div>
            </div>

            <!-- Dashboard -->
            <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                 <div class="bg-slate-800/70 p-4 rounded-xl shadow-lg flex items-center justify-center space-x-4">
                     <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                     <div>
                         <p class="text-sm text-slate-400" data-translate="todaysTarget">Today's Target</p>
                         <p id="target-count" class="text-4xl font-bold text-green-400">0</p>
                     </div>
                 </div>
                 <div class="bg-slate-800/70 p-4 rounded-xl shadow-lg flex items-center justify-center space-x-4">
                      <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.657 7.343A8 8 0 0117.657 18.657z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.343 17.657a8 8 0 0110.607-10.607L15 12l-4.657 5.657z"></path></svg>
                     <div>
                         <p class="text-sm text-slate-400" data-translate="smokedToday">Smoked Today</p>
                         <p id="smoked-count" class="text-4xl font-bold">0</p>
                     </div>
                 </div>
            </div>

             <!-- Action Buttons -->
            <div class="mb-6 space-y-3">
                 <button id="smoked-button" class="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-4 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg" data-translate="smokedButton">I Smoked a Cigarette</button>
                 <div id="limit-reached-controls" class="hidden grid grid-cols-2 gap-3">
                     <button id="limit-reached-button" class="w-full bg-slate-800 text-amber-400 font-bold py-3 px-4 rounded-lg text-sm text-center shadow-md"></button>
                     <button id="urge-button" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white font-bold py-3 px-4 rounded-lg text-sm text-center shadow-lg shadow-cyan-500/20" data-translate="urgeButton">Had an Urge?</button>
                 </div>
                 <button id="help-me-button" class="w-full bg-gradient-to-r from-rose-600 to-red-600 hover:from-rose-700 hover:to-red-700 text-white font-bold py-4 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg shadow-red-500/20" data-translate="helpButton">Emergency "Help Me!"</button>
            </div>
            
             <!-- Progress Log -->
            <div class="flex-grow bg-slate-800/50 rounded-xl p-4 overflow-y-auto shadow-inner">
                 <h3 class="text-lg font-bold mb-4 text-slate-300" data-translate="progressLogTitle">Progress Log</h3>
                 <div class="overflow-x-auto">
                     <table class="w-full text-sm text-left">
                         <thead class="text-xs text-slate-400 uppercase">
                             <tr>
                                 <th scope="col" class="py-3 px-2" data-translate="dateHeader">Date</th>
                                 <th scope="col" class="py-3 px-2 text-center" data-translate="targetHeader">Target</th>
                                 <th scope="col" class="py-3 px-2 text-center" data-translate="smokedHeader">Smoked</th>
                                 <th scope="col" class="py-3 px-2 text-center" data-translate="statusHeader">Status</th>
                             </tr>
                         </thead>
                         <tbody id="progress-table-body" class="divide-y divide-slate-700/50"></tbody>
                     </table>
                 </div>
            </div>
        </div>
        
        <!-- Congratulations Screen -->
        <div id="congrats-screen" class="hidden flex-grow flex flex-col justify-center items-center text-center p-4">
             <div class="text-7xl mb-4">üéâ</div>
             <h2 class="text-4xl font-bold text-green-400 mb-2" data-translate="congratsTitle">Congratulations!</h2>
             <p class="text-slate-300 mb-8 max-w-md" data-translate="congratsSubtitle">You have completed your journey and are now smoke-free! We are proud of you.</p>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm mx-auto text-center modal-content transform scale-95 shadow-2xl border border-slate-700">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-amber-400">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-no-button" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-yes-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes</button>
            </div>
        </div>
    </div>
    <div id="urge-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center p-4 hidden modal-overlay">
         <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm mx-auto text-center modal-content transform scale-95 shadow-2xl border border-slate-700">
             <div class="text-5xl mb-4">üí™</div>
            <h3 class="text-xl font-bold mb-4 text-cyan-400" data-translate="urgeTitle">Stay Strong!</h3>
            <p id="urge-quote" class="text-slate-300 mb-6">A craving is just a thought. You are in control, not the thought.</p>
            <button onclick="closeModal('urge-modal')" class="w-full bg-cyan-500 hover:bg-cyan-600 text-slate-900 font-bold py-2 px-4 rounded-lg" data-translate="urgeCloseButton">I Can Do This!</button>
        </div>
    </div>

    <!-- SOS Screen -->
    <div id="sos-screen" class="fixed inset-0 bg-gradient-to-br from-slate-900 to-gray-900 p-4 hidden sos-overlay flex-col justify-center items-center">
        <div class="w-full max-w-md text-center sos-content">
            <!-- Main SOS Menu -->
            <div id="sos-menu">
                <h2 class="text-3xl font-bold text-red-400 mb-2" data-translate="sosTitle">Craving Emergency</h2>
                <p class="text-slate-400 mb-8" data-translate="sosSubtitle">You are stronger than this craving. Choose an option below.</p>
                <div class="space-y-4">
                    <button data-sos="breathing" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-4 rounded-lg text-lg" data-translate="sosBreathing">Breathing Exercise</button>
                    <button data-sos="motivation" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg text-lg" data-translate="sosMotivation">Get Motivation</button>
                    <button data-sos="game" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg text-lg" data-translate="sosGame">Play a Game</button>
                </div>
                <button id="sos-close-button" class="mt-8 text-slate-400 hover:text-white" data-translate="sosClose">I'm okay now, close this.</button>
            </div>
            
            <!-- Breathing Exercise -->
            <div id="sos-breathing-view" class="hidden flex flex-col items-center justify-center">
                 <h3 class="text-2xl font-bold mb-4" data-translate="breathingTitle">Follow the Guide</h3>
                 <div id="breathing-animation-view">
                    <div id="breathing-circle" class="w-48 h-48 bg-cyan-500 rounded-full mx-auto flex items-center justify-center breathing-animation transform">
                        <p id="breathing-text" class="text-3xl font-bold text-white">Start</p>
                    </div>
                    <p class="text-2xl mt-4">Time Left: <span id="breathing-main-timer">120</span>s</p>
                 </div>
                 <div id="breathing-complete-view" class="hidden">
                     <p class="text-2xl text-green-400 font-bold mb-4" data-translate="breathingCompleteTitle">Well Done!</p>
                     <p class="text-slate-300" data-translate="breathingCompleteText">You took control. The craving has less power now. Keep going!</p>
                     <button id="breathing-done-button" class="mt-8 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-full" data-translate="doneButton">Done</button>
                 </div>
            </div>

             <!-- Motivation -->
            <div id="sos-motivation-view" class="hidden">
                 <h3 class="text-2xl font-bold mb-4" data-translate="motivationTitle">A Powerful Reminder</h3>
                 <div class="bg-slate-800 p-6 rounded-lg">
                    <p id="motivation-quote-text" class="text-lg italic text-slate-300"></p>
                 </div>
                 <button id="motivation-finish-button" class="mt-8 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-full" data-translate="finishButton">Finish</button>
            </div>

            <!-- Game -->
            <div id="sos-game-view" class="hidden">
                <h3 class="text-2xl font-bold mb-4" data-translate="gameTitle">Fruit Slicer!</h3>
                <div class="flex justify-between items-center bg-slate-800 p-2 rounded-lg mb-4">
                    <p>Time: <span id="game-timer">30</span></p>
                    <p>Score: <span id="game-score">0</span></p>
                </div>
                <canvas id="game-canvas" width="350" height="400"></canvas>
                <button id="game-finish-button" class="mt-8 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-full" data-translate="finishButton">Finish</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const setupScreen = document.getElementById('setup-screen');
        const mainScreen = document.getElementById('main-screen');
        const congratsScreen = document.getElementById('congrats-screen');
        const setupForm = document.getElementById('setup-form');
        const initialCigarettesInput = document.getElementById('initial-cigarettes');
        const languageSwitcher = document.getElementById('language-switcher');
        const targetCountEl = document.getElementById('target-count');
        const smokedCountEl = document.getElementById('smoked-count');
        const smokedButton = document.getElementById('smoked-button');
        const limitReachedControls = document.getElementById('limit-reached-controls');
        const limitReachedButton = document.getElementById('limit-reached-button');
        const urgeButton = document.getElementById('urge-button');
        const helpMeButton = document.getElementById('help-me-button');
        const progressTableBody = document.getElementById('progress-table-body');
        const startOverButton = document.getElementById('start-over-button');
        const nextDayButton = document.getElementById('next-day-button');
        const progressCircle = document.getElementById('progress-circle');
        const progressText = document.getElementById('progress-text');
        
        // --- Modals & SOS Screen ---
        const confirmModal = document.getElementById('confirm-modal');
        const urgeModal = document.getElementById('urge-modal');
        const urgeQuoteEl = document.getElementById('urge-quote');
        const sosScreen = document.getElementById('sos-screen');
        const sosMenu = document.getElementById('sos-menu');
        const sosBreathingView = document.getElementById('sos-breathing-view');
        const sosMotivationView = document.getElementById('sos-motivation-view');
        const sosGameView = document.getElementById('sos-game-view');
        const sosCloseButton = document.getElementById('sos-close-button');
        const breathingCircle = document.getElementById('breathing-circle');
        const breathingText = document.getElementById('breathing-text');
        const breathingMainTimerEl = document.getElementById('breathing-main-timer');
        const breathingAnimationView = document.getElementById('breathing-animation-view');
        const breathingCompleteView = document.getElementById('breathing-complete-view');
        const motivationQuoteText = document.getElementById('motivation-quote-text');
        const gameCanvas = document.getElementById('game-canvas');
        const gameTimerEl = document.getElementById('game-timer');
        const gameScoreEl = document.getElementById('game-score');


        // --- App State ---
        let state = {}; 
        let countdownInterval = null;
        let lastUrgeTipIndex = -1;
        let lastMotivationQuoteIndex = -1;
        let currentDate = new Date(); // For testing with next day button
        // SOS State
        let breathingPhaseInterval, breathingMainTimeout, gameLoopId, gameSpawnInterval, gameTimerInterval;


        // --- Translations ---
        const translations = {
             en: {
                appTitle: "Smoke-Free Journey",
                startOverButton: "Start Over",
                overallProgress: "Overall Progress",
                helpButton: "Emergency \"Help Me!\"",
                sosTitle: "Craving Emergency",
                sosSubtitle: "You are stronger than this craving. Choose an option below.",
                sosBreathing: "Breathing Exercise",
                sosMotivation: "Get Motivation",
                sosGame: "Play a Game",
                sosClose: "I'm okay now, close this.",
                breathingTitle: "Follow the Guide",
                motivationTitle: "A Powerful Reminder",
                gameTitle: "Fruit Slicer!",
                finishButton: "Finish",
                doneButton: "Done",
                breathingCompleteTitle: "Well Done!",
                breathingCompleteText: "You took control. The craving has less power now. Keep going!",
                motivationQuotes: [
                    "This craving is temporary, but the damage from smoking is permanent. You've come so far. Don't trade your long-term health for a short-term impulse.",
                    "Remember your 'why'. Picture the healthier, wealthier, and more vibrant life you're building for yourself. Is one cigarette worth giving that up?",
                    "Every craving you defeat is a victory. You are rewriting your story, one moment of strength at a time. Be proud of this moment.",
                    "You are not a smoker trying to quit. You are a non-smoker learning to live without cigarettes. Embrace your new identity.",
                    "Think of this craving as a wave. It feels huge right now, but it will pass. Just ride it out without giving in."
                ],
                urgeTips: [
                    "Take a deep breath and a sip of cold water. Wait 5 minutes, the feeling will pass.",
                    "Eat something you like! A healthy snack can distract you and satisfy cravings.",
                    "Successful people are self-controlled. If you can control this, you can achieve anything.",
                    "Declare your quit date to friends and family. Making a public promise creates powerful motivation to succeed.",
                    "Go for a short walk. Changing your environment can break the craving cycle.",
                ],
             },
            ta: {
                appTitle: "‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æø‡Æï‡Øç‡Æï‡Ææ‡Æ§ ‡Æ™‡ÆØ‡Æ£‡ÆÆ‡Øç",
                startOverButton: "‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ",
                overallProgress: "‡Æí‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡ØÜ‡Ææ‡Æ§‡Øç‡Æ§ ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Øá‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç",
                helpButton: "‡ÆÖ‡Æµ‡Æö‡Æ∞ ‡Æâ‡Æ§‡Æµ‡Æø!",
                sosTitle: "‡Æ§‡ØÄ‡Æµ‡Æø‡Æ∞‡ÆÆ‡Ææ‡Æ© ‡ÆÜ‡Æö‡Øà",
                sosSubtitle: "‡Æá‡Æ®‡Øç‡Æ§ ‡ÆÜ‡Æö‡Øà‡ÆØ‡Øà ‡Æµ‡Æø‡Æü ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æ≤‡Æø‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ©‡Æµ‡Æ∞‡Øç. ‡Æï‡ØÄ‡Æ¥‡Øá ‡Æí‡Æ∞‡ØÅ ‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æ§‡Øç‡Æ§‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                sosBreathing: "‡Æö‡ØÅ‡Æµ‡Ææ‡Æö‡Æ™‡Øç ‡Æ™‡ÆØ‡Æø‡Æ±‡Øç‡Æö‡Æø",
                sosMotivation: "‡Æâ‡Æ®‡Øç‡Æ§‡ØÅ‡Æ§‡Æ≤‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æï",
                sosGame: "‡Æµ‡Æø‡Æ≥‡Øà‡ÆØ‡Ææ‡Æü‡ØÅ",
                sosClose: "‡Æ®‡Ææ‡Æ©‡Øç ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æ®‡Æ≤‡ÆÆ‡Ææ‡Æï ‡Æâ‡Æ≥‡Øç‡Æ≥‡Øá‡Æ©‡Øç.",
                breathingTitle: "‡Æµ‡Æ¥‡Æø‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡Æø‡Æ©‡Øç‡Æ™‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç",
                motivationTitle: "‡Æí‡Æ∞‡ØÅ ‡Æö‡Æï‡Øç‡Æ§‡Æø‡Æµ‡Ææ‡ÆØ‡Øç‡Æ®‡Øç‡Æ§ ‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡ØÇ‡Æü‡Øç‡Æü‡Æ≤‡Øç",
                gameTitle: "‡Æ™‡Æ¥‡ÆÆ‡Øç ‡Æµ‡ØÜ‡Æü‡Øç‡Æü‡Æø!",
                finishButton: "‡ÆÆ‡ØÅ‡Æü‡Æø",
                doneButton: "‡ÆÆ‡ØÅ‡Æü‡Æø‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ",
                breathingCompleteTitle: "‡Æ®‡Æ©‡Øç‡Æ±‡Ææ‡Æï ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç!",
                breathingCompleteText: "‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡Øç‡Æü‡Øà ‡Æé‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æï‡Øç‡Æï‡Øä‡Æ£‡Øç‡Æü‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç. ‡ÆÜ‡Æö‡Øà‡Æï‡Øç‡Æï‡ØÅ ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æö‡Æï‡Øç‡Æ§‡Æø ‡Æï‡ØÅ‡Æ±‡Øà‡Æµ‡ØÅ. ‡Æ§‡Øä‡Æü‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç!",
                motivationQuotes: [
                    "‡Æá‡Æ®‡Øç‡Æ§ ‡Æè‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡Æ§‡Æ±‡Øç‡Æï‡Ææ‡Æ≤‡Æø‡Æï‡ÆÆ‡Ææ‡Æ©‡Æ§‡ØÅ, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡Ææ‡Æ≤‡Øç ‡Æè‡Æ±‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æö‡Øá‡Æ§‡ÆÆ‡Øç ‡Æ®‡Æø‡Æ∞‡Æ®‡Øç‡Æ§‡Æ∞‡ÆÆ‡Ææ‡Æ©‡Æ§‡ØÅ. ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ®‡ØÄ‡Æ£‡Øç‡Æü ‡Æ§‡ØÇ‡Æ∞‡ÆÆ‡Øç ‡Æµ‡Æ®‡Øç‡Æ§‡ØÅ‡Æµ‡Æø‡Æü‡Øç‡Æü‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç.",
                    "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç '‡Æè‡Æ©‡Øç' ‡Æé‡Æ©‡Øç‡Æ™‡Æ§‡Øà ‡Æ®‡Æø‡Æ©‡Øà‡Æµ‡Æø‡Æ≤‡Øç ‡Æï‡Øä‡Æ≥‡Øç‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç. ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æï ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡ÆÜ‡Æ∞‡Øã‡Æï‡Øç‡Æï‡Æø‡ÆØ‡ÆÆ‡Ææ‡Æ©, ‡Æµ‡Æ≥‡ÆÆ‡Ææ‡Æ© ‡Æµ‡Ææ‡Æ¥‡Øç‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Øà ‡Æï‡Æ±‡Øç‡Æ™‡Æ©‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æ™‡Ææ‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.",
                    "‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡Øã‡Æ±‡Øç‡Æï‡Æü‡Æø‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æí‡Æµ‡Øç‡Æµ‡Øä‡Æ∞‡ØÅ ‡Æè‡Æï‡Øç‡Æï‡ÆÆ‡ØÅ‡ÆÆ‡Øç ‡Æí‡Æ∞‡ØÅ ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø. ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æ≤‡Æø‡ÆÆ‡Øà‡ÆØ‡Æø‡Æ©‡Øç ‡Æí‡Æ∞‡ØÅ ‡Æï‡Æ£‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æ§‡Øà‡ÆØ‡Øà ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ¥‡ØÅ‡Æ§‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç.",
                    "‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡Øà ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§ ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æµ‡Æ∞‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤. ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡Æø‡Æï‡Æ∞‡ØÜ‡Æü‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Ææ‡ÆÆ‡Æ≤‡Øç ‡Æµ‡Ææ‡Æ¥‡Æï‡Øç ‡Æï‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Øç‡Æï‡Øä‡Æ≥‡Øç‡Æ≥‡ØÅ‡ÆÆ‡Øç ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æø‡Æï‡Øç‡Æï‡Ææ‡Æ§‡Æµ‡Æ∞‡Øç.",
                    "‡Æá‡Æ®‡Øç‡Æ§ ‡Æè‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà ‡Æí‡Æ∞‡ØÅ ‡ÆÖ‡Æ≤‡Øà‡ÆØ‡Ææ‡Æï ‡Æ®‡Æø‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ‡Æ™‡Øç ‡Æ™‡Ææ‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç. ‡ÆÖ‡Æ§‡ØÅ ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æ™‡ØÜ‡Æ∞‡Æø‡ÆØ‡Æ§‡Ææ‡Æï ‡Æâ‡Æ£‡Æ∞‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç ‡ÆÖ‡Æ§‡ØÅ ‡Æï‡Æü‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ™‡Øã‡Æï‡ØÅ‡ÆÆ‡Øç."
                ],
                urgeTips: [
                    "‡ÆÜ‡Æ¥‡Øç‡Æ®‡Øç‡Æ§ ‡ÆÆ‡ØÇ‡Æö‡Øç‡Æö‡ØÅ ‡Æµ‡Æø‡Æü‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç, ‡Æï‡ØÅ‡Æ≥‡Æø‡Æ∞‡Øç ‡Æ®‡ØÄ‡Æ∞‡Øç ‡Æï‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç. 5 ‡Æ®‡Æø‡ÆÆ‡Æø‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Ææ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç, ‡ÆÖ‡Æ®‡Øç‡Æ§ ‡Æâ‡Æ£‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æï‡Æü‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ™‡Øã‡Æï‡ØÅ‡ÆÆ‡Øç.",
                    "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ‡Æ™‡Øç ‡Æ™‡Æø‡Æü‡Æø‡Æ§‡Øç‡Æ§ ‡Æí‡Æ©‡Øç‡Æ±‡Øà‡Æö‡Øç ‡Æö‡Ææ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç! ‡Æí‡Æ∞‡ØÅ ‡Æö‡Æø‡Æ±‡Øç‡Æ±‡ØÅ‡Æ£‡Øç‡Æü‡Æø ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æµ‡Æ©‡Æ§‡Øç‡Æ§‡Øà ‡Æ§‡Æø‡Æö‡Øà ‡Æ§‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ‡ÆÆ‡Øç.",
                    "‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡Æ©‡Øç‡Æ©‡Æü‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡Æï‡Øä‡Æ£‡Øç‡Æü‡Æµ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç. ‡Æá‡Æ§‡Øà ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Ææ‡Æ≤‡Øç ‡Æï‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§ ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç, ‡Æé‡Æ§‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æö‡Ææ‡Æ§‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç.",
                    "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ®‡Æ£‡Øç‡Æ™‡Æ∞‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æï‡ØÅ‡Æü‡ØÅ‡ÆÆ‡Øç‡Æ™‡Æ§‡Øç‡Æ§‡Æø‡Æ©‡Æ∞‡Æø‡Æü‡ÆÆ‡Øç ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç –±—Ä–æ—Å–∞‡≥Å‡≤µ ‡Æ§‡Øá‡Æ§‡Æø‡ÆØ‡Øà ‡ÆÖ‡Æ±‡Æø‡Æµ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç. ‡Æí‡Æ∞‡ØÅ ‡Æ™‡Øä‡Æ§‡ØÅ ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æ±‡ØÅ‡Æ§‡Æø ‡ÆÖ‡Æ≥‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡ØÅ ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æ™‡ØÜ‡Æ± ‡Æö‡Æï‡Øç‡Æ§‡Æø‡Æµ‡Ææ‡ÆØ‡Øç‡Æ®‡Øç‡Æ§ ‡Æâ‡Æ®‡Øç‡Æ§‡ØÅ‡Æ§‡Æ≤‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.",
                    "‡Æí‡Æ∞‡ØÅ ‡Æö‡Æø‡Æ±‡Æø‡ÆØ ‡Æ®‡Æü‡Øà‡Æ™‡Øç‡Æ™‡ÆØ‡Æø‡Æ±‡Øç‡Æö‡Æø ‡Æö‡ØÜ‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç. ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡ØÇ‡Æ¥‡Æ≤‡Øà ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æµ‡Æ§‡ØÅ ‡ÆÜ‡Æö‡Øà‡ÆØ‡Æø‡Æ©‡Øç ‡Æö‡ØÅ‡Æ¥‡Æ±‡Øç‡Æö‡Æø‡ÆØ‡Øà ‡Æâ‡Æü‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç.",
                ],
            }
        };

        // --- Core App Functions ---
        function init() {
            loadState();
            updateUIForLanguage();
            if (state.plan && state.plan.length > 0) {
                 const finalDay = state.plan[state.plan.length -1];
                 if(finalDay.target === 0 && finalDay.status === 'Pass'){
                     showScreen('congrats');
                 } else {
                     showScreen('main');
                     render();
                     checkDailyStatus();
                 }
            } else {
                showScreen('setup');
            }
            setupEventListeners();
        }
        
        function showScreen(screenName) {
            setupScreen.classList.add('hidden');
            mainScreen.classList.add('hidden');
            congratsScreen.classList.add('hidden');
            startOverButton.classList.add('hidden');
            nextDayButton.classList.add('hidden');

            if(screenName === 'setup') {
                setupScreen.classList.remove('hidden');
            } else if(screenName === 'main') {
                mainScreen.classList.remove('hidden');
                startOverButton.classList.remove('hidden');
                nextDayButton.classList.remove('hidden');
            } else if(screenName === 'congrats') {
                congratsScreen.classList.remove('hidden');
                startOverButton.classList.remove('hidden');
            }
        }

        function setupEventListeners() {
            setupForm.addEventListener('submit', startJourney);
            languageSwitcher.addEventListener('click', toggleLanguage);
            smokedButton.addEventListener('click', handleSmokedClick);
            urgeButton.addEventListener('click', showUrgeModal);
            startOverButton.addEventListener('click', () => showConfirmModal('startOver'));
            document.getElementById('confirm-no-button').addEventListener('click', () => closeModal('confirm-modal'));
            document.getElementById('confirm-yes-button').addEventListener('click', resetJourney);
            nextDayButton.addEventListener('click', goToNextDay);
            
            // SOS Screen Listeners
            helpMeButton.addEventListener('click', showSosScreen);
            sosCloseButton.addEventListener('click', hideSosScreen);
            document.querySelectorAll('[data-sos]').forEach(btn => {
                btn.addEventListener('click', () => handleSosChoice(btn.dataset.sos));
            });
            document.getElementById('breathing-done-button').addEventListener('click', () => showSosView('menu'));
            document.getElementById('motivation-finish-button').addEventListener('click', () => showSosView('menu'));
            document.getElementById('game-finish-button').addEventListener('click', () => showSosView('menu'));
        }

        function goToNextDay() {
            currentDate.setDate(currentDate.getDate() + 1);
            checkDailyStatus();
            render();
            saveState(); // Save the new date
        }

        function generatePlan() { 
            state.plan = []; 
            let planDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
            let dayCounter = 0; 
            while(true) { 
                const weekNumber = Math.floor(dayCounter / 7);
                const dailyTarget = Math.max(0, state.initialCount - weekNumber);
                
                state.plan.push({ date: toISODateString(planDate), target: dailyTarget, smoked: 0, status: 'Pending' }); 
                
                if (dailyTarget === 0) break; 
                
                planDate.setDate(planDate.getDate() + 1); 
                dayCounter++; 
            } 
        }

        function renderDashboard() { 
            const todayEntry = getTodayEntry(); 
            if (todayEntry) { 
                targetCountEl.textContent = todayEntry.target; 
                smokedCountEl.textContent = todayEntry.smoked; 
                
                const progress = state.initialCount > 0 ? ((state.initialCount - todayEntry.target) / state.initialCount) * 100 : 100;
                progressCircle.style.strokeDasharray = `${progress}, 100`;
                progressText.textContent = `${Math.round(progress)}%`;

                 const { smoked, target } = todayEntry; 
                smokedCountEl.classList.remove('text-green-400', 'text-amber-400', 'text-red-400'); 
                if (target > 0) { 
                    if (smoked <= target / 3) smokedCountEl.classList.add('text-green-400'); 
                    else if (smoked <= (target * 2) / 3) smokedCountEl.classList.add('text-amber-400');
                    else smokedCountEl.classList.add('text-red-400'); 
                } else { 
                    smokedCountEl.classList.add('text-green-400'); 
                } 
                if (smoked >= target) { 
                    smokedButton.classList.add('hidden'); 
                    limitReachedControls.classList.remove('hidden'); 
                    limitReachedButton.innerHTML = (translations[state.language] && translations[state.language].limitReachedText) || ''; 
                    startCountdown(); 
                } else { 
                    smokedButton.classList.remove('hidden'); 
                    limitReachedControls.classList.add('hidden'); 
                    stopCountdown(); 
                } 
            } else { 
                targetCountEl.textContent = '0'; 
                smokedCountEl.textContent = '0'; 
                smokedButton.classList.add('hidden'); 
            } 
        }

        // --- SOS Screen Logic ---
        function showSosScreen() { sosScreen.classList.remove('hidden'); sosScreen.classList.add('flex'); showSosView('menu'); }
        function hideSosScreen() { sosScreen.classList.add('hidden'); sosScreen.classList.remove('flex'); stopBreathingExercise(); stopGame(); }
        function handleSosChoice(choice) { showSosView(choice); }

        function showSosView(viewName) {
            sosMenu.classList.add('hidden');
            sosBreathingView.classList.add('hidden');
            sosMotivationView.classList.add('hidden');
            sosGameView.classList.add('hidden');
            stopBreathingExercise();
            stopGame();

            if (viewName === 'menu') sosMenu.classList.remove('hidden');
            if (viewName === 'breathing') { sosBreathingView.classList.remove('hidden'); startBreathingExercise(); }
            if (viewName === 'motivation') { 
                sosMotivationView.classList.remove('hidden');
                const quotes = translations[state.language]?.motivationQuotes;
                if (!quotes) return;
                let randomIndex;
                do { randomIndex = Math.floor(Math.random() * quotes.length); } while (quotes.length > 1 && randomIndex === lastMotivationQuoteIndex);
                lastMotivationQuoteIndex = randomIndex;
                motivationQuoteText.textContent = `"${quotes[randomIndex]}"`;
            }
            if (viewName === 'game') { sosGameView.classList.remove('hidden'); startGame(); }
        }
        
        function startBreathingExercise() {
            breathingAnimationView.classList.remove('hidden');
            breathingCompleteView.classList.add('hidden');
            
            const phases = [ { text: "Breathe In", scale: "scale-125", duration: 4000 }, { text: "Hold", scale: "scale-125", duration: 4000 }, { text: "Breathe Out", scale: "scale-100", duration: 6000 }];
            let currentPhase = -1;
            let mainTimer = 120;
            breathingMainTimerEl.textContent = mainTimer;

            function nextPhase() {
                currentPhase = (currentPhase + 1) % phases.length;
                const phase = phases[currentPhase];
                breathingText.textContent = phase.text;
                breathingCircle.style.transform = phase.scale;
                breathingPhaseInterval = setTimeout(nextPhase, phase.duration);
            }
            
            const mainTimerInterval = setInterval(() => {
                mainTimer--;
                breathingMainTimerEl.textContent = mainTimer;
                if(mainTimer <= 0) clearInterval(mainTimerInterval);
            }, 1000);

            nextPhase();

            breathingMainTimeout = setTimeout(() => {
                stopBreathingExercise();
                breathingAnimationView.classList.add('hidden');
                breathingCompleteView.classList.remove('hidden');
            }, 120000); 
        }
        
        function stopBreathingExercise() {
            clearTimeout(breathingPhaseInterval);
            clearTimeout(breathingMainTimeout);
            breathingText.textContent = "Start";
            breathingCircle.style.transform = "scale-100";
        }

        // --- Game Logic ---
        let score, gameTimer, fruits, sliced, ctx, lastSpawnTime = 0, spawnInterval = 1000;
        const gravity = 0.05;

        function startGame() {
            ctx = gameCanvas.getContext('2d');
            score = 0;
            gameTimer = 30;
            fruits = [];
            sliced = [];
            gameScoreEl.textContent = score;
            gameTimerEl.textContent = gameTimer;

            gameTimerInterval = setInterval(() => {
                gameTimer--;
                gameTimerEl.textContent = gameTimer;
                if (gameTimer <= 0) stopGame();
            }, 1000);
            
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function stopGame() {
            clearInterval(gameTimerInterval);
            cancelAnimationFrame(gameLoopId);
            setTimeout(() => {
                 alert(`Game over! Your score: ${score}`);
                 showSosView('menu');
            }, 100);
        }
        
        function gameLoop(timestamp) {
            if (gameTimer <= 0) return;
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

            if (timestamp - lastSpawnTime > spawnInterval) {
                spawnFruit();
                lastSpawnTime = timestamp;
                spawnInterval = Math.random() * 800 + 400;
            }

            fruits.forEach((fruit, index) => {
                fruit.vy += gravity;
                fruit.x += fruit.vx;
                fruit.y += fruit.vy;
                if (fruit.y > gameCanvas.height + fruit.radius) fruits.splice(index, 1);
                
                ctx.fillStyle = fruit.color;
                ctx.beginPath();
                ctx.arc(fruit.x, fruit.y, fruit.radius, 0, Math.PI * 2);
                ctx.fill();
            });
            
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function spawnFruit() {
             const radius = Math.random() * 15 + 15;
             const x = Math.random() * (gameCanvas.width - 100) + 50;
             const y = gameCanvas.height + radius;
             const vx = Math.random() * 4 - 2;
             const vy = -(Math.random() * 5 + 5);
             const colors = ['#EF4444', '#F59E0B', '#10B981', '#8B5CF6']; // red, amber, green, purple
             const color = colors[Math.floor(Math.random() * colors.length)];
             fruits.push({ x, y, radius, vx, vy, color });
        }
        
        let mouse = { x: 0, y: 0, lastX: 0, lastY: 0 };
        let isSwiping = false;

        gameCanvas.addEventListener('mousedown', e => isSwiping = true);
        gameCanvas.addEventListener('mouseup', e => isSwiping = false);
        gameCanvas.addEventListener('mouseleave', e => isSwiping = false);
        gameCanvas.addEventListener('mousemove', e => {
            if (!isSwiping) return;
            const rect = gameCanvas.getBoundingClientRect();
            mouse.lastX = mouse.x;
            mouse.lastY = mouse.y;
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
            checkSlice();
        });

        function checkSlice() {
            for (let i = fruits.length - 1; i >= 0; i--) {
                const fruit = fruits[i];
                const dist = Math.hypot(fruit.x - mouse.x, fruit.y - mouse.y);
                if (dist < fruit.radius) {
                    fruits.splice(i, 1);
                    score++;
                    gameScoreEl.textContent = score;
                }
            }
        }


        // --- Existing Helper Functions ---
        function getTodayEntry() { if (!state.plan) return null; return state.plan.find(day => day.date === getTodayDateString()); }
        function toISODateString(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getTodayDateString() { return toISODateString(currentDate); }
        function getYesterdayDateString() { const yesterday = new Date(currentDate); yesterday.setDate(yesterday.getDate() - 1); return toISODateString(yesterday); }
        function formatDate(dateString) { const date = new Date(dateString); const options = { month: 'short', day: 'numeric', timeZone: 'UTC' }; return date.toLocaleDateString(state.language === 'ta' ? 'ta-IN' : 'en-US', options); }
        function resetJourney() { localStorage.removeItem('smokeFreeJourneyState'); state = {}; location.reload(); }
        function showConfirmModal(type) { 
            const confirmTitle = document.getElementById('confirm-modal-title');
            const confirmText = document.getElementById('confirm-modal-text');
            if (type === 'startOver') { 
                confirmTitle.textContent = (translations[state.language] && translations[state.language].confirmStartOverTitle) || "Start Over?"; 
                confirmText.textContent = (translations[state.language] && translations[state.language].confirmStartOverText) || "All your progress will be lost."; 
            } 
            confirmModal.classList.remove('hidden'); 
            confirmModal.querySelector('.modal-content').classList.add('scale-100'); 
        }
        function closeModal(modalId) { const modal = document.getElementById(modalId); modal.querySelector('.modal-content').classList.remove('scale-100'); modal.classList.add('hidden'); }
        function showUrgeModal() { const urgeTips = translations[state.language]?.urgeTips; if (!urgeTips || urgeTips.length === 0) return; let randomIndex; do { randomIndex = Math.floor(Math.random() * urgeTips.length); } while (urgeTips.length > 1 && randomIndex === lastUrgeTipIndex); lastUrgeTipIndex = randomIndex; const randomTip = urgeTips[randomIndex]; if (urgeQuoteEl && urgeModal) { urgeQuoteEl.textContent = randomTip; urgeModal.classList.remove('hidden'); urgeModal.querySelector('.modal-content').classList.add('scale-100'); } }
        function saveState() { 
            state.currentDate = currentDate.toISOString();
            localStorage.setItem('smokeFreeJourneyState', JSON.stringify(state)); 
        }
        function loadState() { const savedState = localStorage.getItem('smokeFreeJourneyState'); if (savedState) { state = JSON.parse(savedState); if(state.currentDate) { currentDate = new Date(state.currentDate); } } else { state = { language: 'en', plan: [], startDate: null, initialCount: 0, lastCheckedDate: null }; } }
        function render() { renderDashboard(); renderTable(); }
        function renderTable() { progressTableBody.innerHTML = ''; const todayStr = getTodayDateString(); if (!state.plan) return; state.plan.forEach(day => { const isToday = day.date === todayStr; const rowClass = isToday ? 'bg-slate-700/50 font-semibold' : ''; let statusClass = ''; let statusText = (translations[state.language] && translations[state.language].statusPending) || 'Pending'; if (day.status === 'Pass') { statusClass = 'text-green-400'; statusText = (translations[state.language] && translations[state.language].statusPass) || 'Pass'; } else if (day.status === 'Fail') { statusClass = 'text-red-400'; statusText = (translations[state.language] && translations[state.language].statusFail) || 'Fail'; } else if (day.status === 'Waiting') { statusClass = 'text-amber-400'; statusText = (translations[state.language] && translations[state.language].statusWaiting) || 'Wait'; } const row = `<tr class="${rowClass}"><td class="py-3 px-2">${formatDate(day.date)}</td><td class="py-3 px-2 text-center">${day.target}</td><td class="py-3 px-2 text-center">${day.smoked}</td><td class="py-3 px-2 text-center font-semibold ${statusClass}">${statusText}</td></tr>`; progressTableBody.insertAdjacentHTML('beforeend', row); }); }
        function startCountdown() { if (countdownInterval) clearInterval(countdownInterval); countdownInterval = setInterval(() => { const now = new Date(); const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0); const diff = midnight - now; if (diff <= 1000) { stopCountdown(); setTimeout(() => location.reload(), 1000); return; } const hours = String(Math.floor((diff / (1000 * 60 * 60)) % 24)).padStart(2, '0'); const minutes = String(Math.floor((diff / 1000 / 60) % 60)).padStart(2, '0'); const seconds = String(Math.floor((diff / 1000) % 60)).padStart(2, '0'); const countdownSpan = document.getElementById('countdown-timer'); if (countdownSpan) { countdownSpan.textContent = `${hours}:${minutes}:${seconds}`; } }, 1000); }
        function stopCountdown() { if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; } }
        function updateUIForLanguage() { 
            languageSwitcher.textContent = state.language === 'en' ? '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' : 'English'; 
            document.querySelectorAll('[data-translate]').forEach(el => { 
                const key = el.getAttribute('data-translate'); 
                if (translations[state.language] && translations[state.language][key]) { 
                    el.innerHTML = translations[state.language][key]; 
                } 
            }); 
        }
        
        function checkDailyStatus() {
            const todayStr = getTodayDateString();
            if(!state.plan || state.lastCheckedDate === todayStr) return;
            
            let showMotivation = false;
            
            state.plan.forEach(day => {
                if (day.date < todayStr && (day.status === 'Pending' || day.status === 'Waiting')) {
                    day.status = day.smoked <= day.target ? 'Pass' : 'Fail';
                    if (day.date === getYesterdayDateString() && day.status === 'Pass') {
                        showMotivation = true;
                    }
                }
            });

            if (showMotivation) { showConfirmModal('motivation'); }

            state.lastCheckedDate = todayStr;
            saveState();
            renderTable();
        }
        
        function handleSmokedClick() {
            const todayEntry = getTodayEntry();
            if (todayEntry && todayEntry.smoked < todayEntry.target) {
                todayEntry.smoked += 1;
                if (todayEntry.smoked >= todayEntry.target) {
                    todayEntry.status = 'Waiting';
                }
                saveState();
                render();
            }
        }

        function startJourney(e) {
            e.preventDefault();
            const count = parseInt(initialCigarettesInput.value);
            if (count > 0) {
                state.initialCount = count;
                state.startDate = getTodayDateString();
                state.lastCheckedDate = getYesterdayDateString();
                generatePlan();
                saveState();
                showScreen('main');
                render();
            }
        }
        
        function toggleLanguage() {
            state.language = state.language === 'en' ? 'ta' : 'en';
            saveState();
            updateUIForLanguage();
            if (state.plan && state.plan.length > 0) {
                render(); 
            }
        }


        init();
    </script>
</body>
</html>

