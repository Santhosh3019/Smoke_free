<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smoke-Free Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay, .sos-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content, .sos-content { transition: transform 0.3s ease-in-out; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Breathing Animation */
        #sos-breathing-view.active {
            position: fixed;
            inset: 0;
            background: linear-gradient(160deg, #0f172a 0%, #1e293b 100%);
            z-index: 100;
        }
        #breathing-guide {
            width: 250px;
            height: 250px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #breathing-outer-ring {
            position: absolute;
            inset: 0;
            border: 2px solid rgba(6, 182, 212, 0.2);
            border-radius: 50%;
            transition: transform 4s ease-in-out;
        }
        #breathing-inner-circle {
            width: 75%;
            height: 75%;
            background: radial-gradient(circle, #0e7490, #164e63);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(6, 182, 212, 0.5);
            transition: transform 4s ease-in-out;
        }
        #breathing-instruction {
            position: absolute;
            color: white;
            font-size: 2rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        #breathing-instruction.visible {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">

    <!-- Main Container -->
    <div id="app-container" class="min-h-screen max-w-lg mx-auto p-4 flex flex-col fade-in">
        
        <!-- Header -->
        <header id="app-header" class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-slate-900 tracking-wide" data-translate="appTitle">Smoke-Free Journey</h1>
            <div class="flex items-center space-x-2">
                <button id="start-over-button" class="hidden text-xs text-slate-500 hover:text-slate-800 transition-colors" data-translate="startOverButton">Start Over</button>
                <button id="next-day-button" class="hidden px-2 py-1 text-xs font-semibold bg-white border border-slate-200 text-slate-700 rounded-full hover:bg-slate-50">Advance Day</button>
                <button id="language-switcher" class="px-3 py-1 text-sm font-semibold bg-white border border-slate-200 text-slate-700 rounded-full hover:bg-slate-50 transition-colors shadow-sm">à®¤à®®à®¿à®´à¯</button>
            </div>
        </header>

        <!-- Initial Setup Screen -->
        <div id="setup-screen" class="hidden flex-grow flex flex-col justify-center items-center text-center p-4">
             <div class="w-full bg-white border border-slate-200 p-8 rounded-2xl shadow-lg">
                 <h2 class="text-3xl font-bold mb-2 text-slate-900" data-translate="welcomeTitle">Welcome!</h2>
                 <p class="text-slate-500 mb-8" data-translate="welcomeSubtitle">Let's start your journey to a smoke-free life.</p>
                 <form id="setup-form" class="space-y-6">
                     <label for="initial-cigarettes" class="block text-lg font-medium mb-2" data-translate="initialCigarettesLabel">How many cigarettes do you smoke per day?</label>
                     <input type="number" id="initial-cigarettes" class="w-full bg-slate-50 border-2 border-slate-300 text-slate-900 text-center text-3xl rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" placeholder="e.g., 15" required min="1">
                     <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 shadow-lg shadow-cyan-500/20" data-translate="startButton">Start Journey</button>
                 </form>
             </div>
        </div>

        <!-- Main App Screen -->
        <div id="main-screen" class="hidden flex-grow flex flex-col">

            <!-- Dashboard -->
            <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                 <div class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm flex flex-col items-center justify-center">
                     <p class="text-sm text-slate-500" data-translate="todaysTarget">Today's Target</p>
                     <p id="target-count" class="text-4xl font-bold text-cyan-500">0</p>
                 </div>
                 <div class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm flex flex-col items-center justify-center">
                     <p class="text-sm text-slate-500" data-translate="smokedToday">Smoked Today</p>
                     <p id="smoked-count" class="text-4xl font-bold text-slate-800">0</p>
                 </div>
            </div>

             <!-- Action Buttons -->
            <div class="mb-6 space-y-3">
                 <button id="smoked-button" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-4 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-sm" data-translate="smokedButton">I Smoked a Cigarette</button>
                 <div id="limit-reached-controls" class="hidden">
                     <button id="limit-reached-button" class="w-full bg-white border border-slate-200 text-amber-500 font-bold py-3 px-4 rounded-lg text-sm text-center shadow-sm mb-3"></button>
                 </div>
                 <button id="urge-button" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:opacity-90 text-white font-bold py-4 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg shadow-cyan-500/20" data-translate="urgeButton">Had an Urge?</button>
            </div>
            
            <!-- Running Message -->
            <div class="bg-white border border-slate-200 rounded-lg p-2 mb-6 shadow-sm">
                 <p class="text-cyan-600 text-sm" data-translate="runningMessage"></p>
            </div>
            
             <!-- Progress Log -->
             <div class="flex-grow bg-white border border-slate-200 rounded-xl p-4 overflow-y-auto shadow-sm min-h-0">
                 <h3 class="text-lg font-bold mb-4 text-slate-900" data-translate="progressLogTitle">Progress Log</h3>
                 <div class="overflow-x-auto">
                     <table class="w-full text-sm text-left">
                         <thead class="text-xs text-slate-500 uppercase">
                             <tr>
                                 <th scope="col" class="py-3 px-2" data-translate="dateHeader">Date</th>
                                 <th scope="col" class="py-3 px-2 text-center" data-translate="targetHeader">Target</th>
                                 <th scope="col" class="py-3 px-2 text-center" data-translate="smokedHeader">Smoked</th>
                                 <th scope="col" class="py-3 px-2 text-center" data-translate="statusHeader">Status</th>
                                 <th scope="col" class="py-3 px-2 text-center" data-translate="progressHeader">Progress</th>
                             </tr>
                         </thead>
                         <tbody id="progress-table-body" class="divide-y divide-slate-200"></tbody>
                     </table>
                 </div>
            </div>
        </div>
        
        <!-- Congratulations Screen -->
        <div id="congrats-screen" class="hidden flex-grow flex flex-col justify-center items-center text-center p-4">
             <div class="text-7xl mb-4">ğŸ‰</div>
             <h2 class="text-4xl font-bold text-cyan-500 mb-2" data-translate="congratsTitle">You Made It!</h2>
             <p class="text-slate-600 mb-6 max-w-md" data-translate="congratsSubtitle">You have completed your journey and are now smoke-free! We are proud of you.</p>
             <p class="text-slate-500 text-sm italic max-w-md" data-translate="congratsQuote">"Don't compromise on a single cigarette. The journey was long, but your freedom is worth it. Stay vigilant, stay strong."</p>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm mx-auto text-center modal-content transform scale-95 shadow-2xl border border-slate-200">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-amber-500">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-slate-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-no-button" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-yes-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes</button>
            </div>
        </div>
    </div>

    <!-- NEW: Appreciation Modal -->
    <div id="appreciation-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm mx-auto text-center modal-content transform scale-95 shadow-2xl border border-slate-200">
            <div class="text-5xl mb-4">ğŸ‰</div>
            <h3 id="appreciation-modal-title" class="text-2xl font-bold mb-2 text-green-500">Great Job!</h3>
            <p id="appreciation-modal-text" class="text-slate-600 mb-6"></p>
            <button id="appreciation-close-button" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>

    <!-- SOS Screen -->
    <div id="sos-screen" class="fixed inset-0 bg-slate-100 p-4 hidden sos-overlay flex-col justify-center items-center">
        <div class="w-full h-full text-center sos-content flex flex-col items-center justify-center">
            <!-- Main SOS Menu -->
            <div id="sos-menu" class="w-full max-w-md">
                <h2 class="text-3xl font-bold text-cyan-600 mb-2" data-translate="sosTitle">Craving Emergency</h2>
                <p class="text-slate-500 mb-8" data-translate="sosSubtitle">You are stronger than this craving. Choose an option below.</p>
                <div class="space-y-4">
                    <button data-sos="breathing" class="w-full bg-white hover:bg-slate-50 border border-slate-200 text-slate-800 font-bold py-4 rounded-lg text-lg" data-translate="sosBreathing">Breathing Exercise</button>
                    <button data-sos="motivation" class="w-full bg-white hover:bg-slate-50 border border-slate-200 text-slate-800 font-bold py-4 rounded-lg text-lg" data-translate="sosMotivation">Get Motivation</button>
                    <a href="Game/index.html" class="block">
                        <button class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:opacity-90 text-white font-bold py-4 rounded-lg text-lg" data-translate="sosGame">Play a Game</button>
                    </a>
                </div>
                <button id="sos-close-button" class="mt-8 text-slate-500 hover:text-slate-800" data-translate="sosClose">I'm okay now, close this.</button>
            </div>
            
            <!-- Breathing Exercise -->
            <div id="sos-breathing-view" class="hidden flex-col items-center justify-center">
                <div id="breathing-animation-view" class="w-full h-full flex flex-col items-center justify-center">
                    <div id="breathing-guide">
                        <div id="breathing-outer-ring"></div>
                        <div id="breathing-inner-circle"></div>
                        <p id="breathing-instruction"></p>
                    </div>
                    <p class="absolute top-5 text-xl text-slate-400">Total Time: <span id="breathing-main-timer">120</span>s</p>
                    <button id="breathing-back-button" class="absolute bottom-10 bg-white/10 hover:bg-white/20 text-white font-bold py-2 px-6 rounded-full text-sm backdrop-blur-sm" data-translate="backButton">Back to Menu</button>
                </div>
                <div id="breathing-complete-view" class="hidden w-full h-full flex-col items-center justify-center text-center p-4">
                     <p class="text-3xl text-green-400 font-bold mb-4" data-translate="breathingCompleteTitle">Well Done!</p>
                     <p class="text-slate-400 text-lg" data-translate="breathingCompleteText">You took control. The craving has less power now. Keep going!</p>
                     <button id="breathing-done-button" class="mt-8 bg-white/10 hover:bg-white/20 text-white font-bold py-3 px-8 rounded-full" data-translate="feelBetterButton">I Feel Better</button>
                </div>
            </div>

             <!-- Motivation -->
            <div id="sos-motivation-view" class="hidden w-full max-w-md">
                 <h3 class="text-2xl font-bold mb-4" data-translate="motivationTitle">A Powerful Reminder</h3>
                 <div class="bg-white border border-slate-200 p-6 rounded-lg min-h-[150px] flex items-center justify-center">
                    <p id="motivation-quote-text" class="text-lg italic text-slate-600"></p>
                 </div>
                 <div class="mt-8 flex space-x-4">
                    <button id="motivation-back-button" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-full" data-translate="backButton">Back to Menu</button>
                 </div>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const setupScreen = document.getElementById('setup-screen');
        const mainScreen = document.getElementById('main-screen');
        const congratsScreen = document.getElementById('congrats-screen');
        const setupForm = document.getElementById('setup-form');
        const initialCigarettesInput = document.getElementById('initial-cigarettes');
        const languageSwitcher = document.getElementById('language-switcher');
        const targetCountEl = document.getElementById('target-count');
        const smokedCountEl = document.getElementById('smoked-count');
        const smokedButton = document.getElementById('smoked-button');
        const limitReachedControls = document.getElementById('limit-reached-controls');
        const limitReachedButton = document.getElementById('limit-reached-button');
        const urgeButton = document.getElementById('urge-button');
        const progressTableBody = document.getElementById('progress-table-body');
        const startOverButton = document.getElementById('start-over-button');
        
        // --- Modals & SOS Screen ---
        const confirmModal = document.getElementById('confirm-modal');
        const sosScreen = document.getElementById('sos-screen');
        const sosMenu = document.getElementById('sos-menu');
        const sosBreathingView = document.getElementById('sos-breathing-view');
        const sosMotivationView = document.getElementById('sos-motivation-view');
        const sosCloseButton = document.getElementById('sos-close-button');
        const breathingAnimationView = document.getElementById('breathing-animation-view');
        const breathingCompleteView = document.getElementById('breathing-complete-view');
        const motivationQuoteText = document.getElementById('motivation-quote-text');
        const nextDayButton = document.getElementById('next-day-button');
        const appreciationModal = document.getElementById('appreciation-modal');

        // --- App State ---
        let state = {}; 
        let countdownInterval = null;
        let lastMotivationQuoteIndex = -1;
        let mockDate = null;
        
        // SOS State
        let breathingIntervals = [];

        // --- Translations ---
        const translations = {
             en: {
                appTitle: "Smoke-Free Journey",
                startOverButton: "Start Over",
                urgeButton: "Had an Urge?",
                sosTitle: "Craving Emergency",
                sosSubtitle: "You are stronger than this craving. Choose an option below.",
                sosBreathing: "Breathing Exercise",
                sosMotivation: "Get Motivation",
                sosGame: "Play a Game",
                sosClose: "I'm okay now, close this.",
                breathingTitle: "Follow the Guide",
                motivationTitle: "A Powerful Reminder",
                backButton: "Back to Menu",
                feelBetterButton: "I Feel Better",
                breathingCompleteTitle: "Well Done!",
                breathingCompleteText: "You took control. The craving has less power now. Keep going!",
                runningMessage: "Don't be a slave to a stick of paper and leaves. Break the chains with every craving you conquer.",
                limitReachedText: "Next in <span id='countdown-timer' class='text-slate-800'>--:--:--</span>",
                motivationQuotes: [
                    "This craving is temporary, but the damage from smoking is permanent. You've come so far. Don't trade your long-term health for a short-term impulse.",
                    "Remember your 'why'. Picture the healthier, wealthier, and more vibrant life you're building for yourself. Is one cigarette worth giving that up?",
                    "Every craving you defeat is a victory. You are rewriting your story, one moment of strength at a time. Be proud of this moment.",
                    "You are not a smoker trying to quit. You are a non-smoker learning to live without cigarettes. Embrace your new identity.",
                    "Think of this craving as a wave. It feels huge right now, but it will pass. Just ride it out without giving in."
                ],
                appreciationMessages: [
                    "Another day conquered! Your strength is inspiring.",
                    "You did it! Every smoke-free day is a massive win for your health.",
                    "Fantastic work yesterday! Keep building on this momentum.",
                    "Success! You're proving to yourself how powerful you are.",
                    "Well done! You're one day closer to a completely smoke-free life."
                ],
                congratsTitle: "You Made It!",
                congratsQuote: "\"Don't compromise on a single cigarette. The journey was long, but your freedom is worth it. Stay vigilant, stay strong.\"",
                confirmStartOverTitle: "Are you sure you want to start over?",
                confirmStartOverText: "This is a long and challenging process. Starting again means losing all your hard-earned progress. Don't give up on your freedom so easily!",
                progressHeader: "Progress",
                welcomeTitle: "Welcome!",
                welcomeSubtitle: "Let's start your journey to a smoke-free life.",
                initialCigarettesLabel: "How many cigarettes do you smoke per day?",
                startButton: "Start Journey",
                todaysTarget: "Today's Target",
                smokedToday: "Smoked Today",
                smokedButton: "I Smoked a Cigarette",
                progressLogTitle: "Progress Log",
                dateHeader: "Date",
                targetHeader: "Target",
                smokedHeader: "Smoked",
                statusHeader: "Status",
             },
            ta: {
                appTitle: "à®ªà¯à®•à¯ˆ-à®‡à®²à¯à®²à®¾ à®ªà®¯à®£à®®à¯",
                startOverButton: "à®ªà¯à®¤à®¿à®¤à®¾à®•à®¤à¯ à®¤à¯Šà®Ÿà®™à¯à®•à¯",
                urgeButton: "à®’à®°à¯ à®†à®šà¯ˆ à®‡à®°à¯à®¨à¯à®¤à®¤à¯?",
                sosTitle: "à®…à®µà®šà®° à®‰à®¤à®µà®¿",
                sosSubtitle: "à®‡à®¨à¯à®¤ à®†à®šà¯ˆà®¯à¯ˆ à®µà®¿à®Ÿ à®¨à¯€à®™à¯à®•à®³à¯ à®µà®²à®¿à®®à¯ˆà®¯à®¾à®©à®µà®°à¯. à®•à¯€à®´à¯‡ à®’à®°à¯ à®µà®¿à®°à¯à®ªà¯à®ªà®¤à¯à®¤à¯ˆà®¤à¯ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯à®•à¯à®•à®µà¯à®®à¯.",
                sosBreathing: "à®šà¯à®µà®¾à®šà®ªà¯ à®ªà®¯à®¿à®±à¯à®šà®¿",
                sosMotivation: "à®‰à®¨à¯à®¤à¯à®¤à®²à¯ à®ªà¯†à®±à¯à®™à¯à®•à®³à¯",
                sosGame: "à®µà®¿à®³à¯ˆà®¯à®¾à®Ÿà¯",
                sosClose: "à®¨à®¾à®©à¯ à®‡à®ªà¯à®ªà¯‹à®¤à¯ à®¨à®²à®®à®¾à®• à®‰à®³à¯à®³à¯‡à®©à¯, à®‡à®¤à¯ˆ à®®à¯‚à®Ÿà¯.",
                breathingTitle: "à®µà®´à®¿à®•à®¾à®Ÿà¯à®Ÿà®¿à®¯à¯ˆà®ªà¯ à®ªà®¿à®©à¯à®ªà®±à¯à®±à®µà¯à®®à¯",
                motivationTitle: "à®’à®°à¯ à®šà®•à¯à®¤à®¿à®µà®¾à®¯à¯à®¨à¯à®¤ à®¨à®¿à®©à¯ˆà®µà¯‚à®Ÿà¯à®Ÿà®²à¯",
                backButton: "à®®à¯à®•à¯à®•à®¿à®¯ à®®à¯†à®©à¯à®µà®¿à®±à¯à®•à¯à®¤à¯ à®¤à®¿à®°à¯à®®à¯à®ªà¯",
                feelBetterButton: "à®¨à®¾à®©à¯ à®¨à®©à¯à®±à®¾à®• à®‰à®£à®°à¯à®•à®¿à®±à¯‡à®©à¯",
                breathingCompleteTitle: "à®¨à®©à¯à®±à®¾à®• à®šà¯†à®¯à¯à®¤à¯€à®°à¯à®•à®³à¯!",
                breathingCompleteText: "à®¨à¯€à®™à¯à®•à®³à¯ à®•à®Ÿà¯à®Ÿà¯à®ªà¯à®ªà®¾à®Ÿà¯à®Ÿà¯ˆ à®à®Ÿà¯à®¤à¯à®¤à¯à®³à¯à®³à¯€à®°à¯à®•à®³à¯. à®‡à®ªà¯à®ªà¯‹à®¤à¯ à®†à®šà¯ˆà®•à¯à®•à¯ à®…à®¤à®¿à®• à®šà®•à¯à®¤à®¿ à®‡à®²à¯à®²à¯ˆ. à®¤à¯†à®¾à®Ÿà®°à¯à®¨à¯à®¤à¯ à®šà¯†à®²à¯à®²à¯à®™à¯à®•à®³à¯!",
                runningMessage: "à®’à®°à¯ à®•à®¾à®•à®¿à®¤à®®à¯ à®®à®±à¯à®±à¯à®®à¯ à®‡à®²à¯ˆà®•à®³à®¿à®©à¯ à®•à¯à®šà¯à®šà®¿à®•à¯à®•à¯ à®…à®Ÿà®¿à®®à¯ˆà®¯à®¾à®• à®‡à®°à¯à®•à¯à®• à®µà¯‡à®£à¯à®Ÿà®¾à®®à¯. à®¨à¯€à®™à¯à®•à®³à¯ à®µà¯†à®²à¯à®²à¯à®®à¯ à®’à®µà¯à®µà¯Šà®°à¯ à®†à®šà¯ˆà®¯à¯à®Ÿà®©à¯à®®à¯ à®šà®™à¯à®•à®¿à®²à®¿à®•à®³à¯ˆ à®‰à®Ÿà¯ˆà®•à¯à®•à®µà¯à®®à¯.",
                limitReachedText: "à®…à®Ÿà¯à®¤à¯à®¤à¯ <span id='countdown-timer' class='text-slate-800'>--:--:--</span>",
                appreciationMessages: [
                    "à®‡à®©à¯à®©à¯Šà®°à¯ à®¨à®¾à®³à¯ à®µà¯†à®±à¯à®±à®¿! à®‰à®™à¯à®•à®³à¯ à®µà®²à®¿à®®à¯ˆ à®Šà®•à¯à®•à®®à®³à®¿à®•à¯à®•à®¿à®±à®¤à¯.",
                    "à®¨à¯€à®™à¯à®•à®³à¯ à®šà¯†à®¯à¯à®¤à¯€à®°à¯à®•à®³à¯! à®’à®µà¯à®µà¯Šà®°à¯ à®ªà¯à®•à¯ˆà®ªà¯à®ªà®¿à®Ÿà®¿à®•à¯à®•à®¾à®¤ à®¨à®¾à®³à¯à®®à¯ à®‰à®™à¯à®•à®³à¯ à®†à®°à¯‹à®•à¯à®•à®¿à®¯à®¤à¯à®¤à®¿à®±à¯à®•à¯ à®’à®°à¯ à®ªà¯†à®°à®¿à®¯ à®µà¯†à®±à¯à®±à®¿.",
                    "à®¨à¯‡à®±à¯à®±à¯ˆà®¯ à®…à®°à¯à®®à¯ˆà®¯à®¾à®© à®µà¯‡à®²à¯ˆ! à®‡à®¨à¯à®¤ à®µà¯‡à®•à®¤à¯à®¤à®¿à®²à¯ à®¤à¯Šà®Ÿà®°à¯à®¨à¯à®¤à¯ à®®à¯à®©à¯à®©à¯‡à®±à¯à®™à¯à®•à®³à¯.",
                    "à®µà¯†à®±à¯à®±à®¿! à®¨à¯€à®™à¯à®•à®³à¯ à®à®µà¯à®µà®³à®µà¯ à®šà®•à¯à®¤à®¿à®µà®¾à®¯à¯à®¨à¯à®¤à®µà®°à¯ à®à®©à¯à®ªà®¤à¯ˆ à®¨à¯€à®™à¯à®•à®³à¯‡ à®¨à®¿à®°à¯‚à®ªà®¿à®•à¯à®•à®¿à®±à¯€à®°à¯à®•à®³à¯.",
                    "à®¨à®©à¯à®±à®¾à®• à®šà¯†à®¯à¯à®¤à¯€à®°à¯à®•à®³à¯! à®¨à¯€à®™à¯à®•à®³à¯ à®®à¯à®´à¯à®®à¯ˆà®¯à®¾à®• à®ªà¯à®•à¯ˆà®ªà¯à®ªà®¿à®Ÿà®¿à®•à¯à®•à®¾à®¤ à®µà®¾à®´à¯à®•à¯à®•à¯ˆà®•à¯à®•à¯ à®’à®°à¯ à®¨à®¾à®³à¯ à®¨à¯†à®°à¯à®•à¯à®•à®®à®¾à®• à®‰à®³à¯à®³à¯€à®°à¯à®•à®³à¯."
                ],
                congratsTitle: "à®¨à¯€à®™à¯à®•à®³à¯ à®šà®¾à®¤à®¿à®¤à¯à®¤à¯à®µà®¿à®Ÿà¯à®Ÿà¯€à®°à¯à®•à®³à¯!",
                congratsQuote: "\"à®’à®°à¯‡ à®’à®°à¯ à®šà®¿à®•à®°à¯†à®Ÿà¯à®Ÿà®¿à®²à¯ à®šà®®à®°à®šà®®à¯ à®šà¯†à®¯à¯à®¯à®¾à®¤à¯€à®°à¯à®•à®³à¯. à®ªà®¯à®£à®®à¯ à®¨à¯€à®£à¯à®Ÿà®¤à¯, à®†à®©à®¾à®²à¯ à®‰à®™à¯à®•à®³à¯ à®šà¯à®¤à®¨à¯à®¤à®¿à®°à®®à¯ à®®à®¤à®¿à®ªà¯à®ªà¯à®®à®¿à®•à¯à®•à®¤à¯. à®µà®¿à®´à®¿à®ªà¯à®ªà¯à®Ÿà®©à¯ à®‡à®°à¯à®™à¯à®•à®³à¯, à®µà®²à®¿à®®à¯ˆà®¯à®¾à®• à®‡à®°à¯à®™à¯à®•à®³à¯.\"",
                confirmStartOverTitle: "à®ªà¯à®¤à®¿à®¤à®¾à®•à®¤à¯ à®¤à¯Šà®Ÿà®™à¯à®• à®µà®¿à®°à¯à®®à¯à®ªà¯à®•à®¿à®±à¯€à®°à¯à®•à®³à®¾?",
                confirmStartOverText: "à®‡à®¤à¯ à®’à®°à¯ à®¨à¯€à®£à¯à®Ÿ à®®à®±à¯à®±à¯à®®à¯ à®šà®µà®¾à®²à®¾à®© à®šà¯†à®¯à®²à¯à®®à¯à®±à¯ˆ. à®®à¯€à®£à¯à®Ÿà¯à®®à¯ à®¤à¯Šà®Ÿà®™à¯à®•à¯à®µà®¤à¯ à®à®©à¯à®ªà®¤à¯ à®‰à®™à¯à®•à®³à¯ à®•à®Ÿà®¿à®©à®®à®¾à®• à®šà®®à¯à®ªà®¾à®¤à®¿à®¤à¯à®¤ à®®à¯à®©à¯à®©à¯‡à®±à¯à®±à®¤à¯à®¤à¯ˆ à®‡à®´à®ªà¯à®ªà®¤à®¾à®•à¯à®®à¯. à®‰à®™à¯à®•à®³à¯ à®šà¯à®¤à®¨à¯à®¤à®¿à®°à®¤à¯à®¤à¯ˆ à®à®³à®¿à®¤à®¿à®²à¯ à®µà®¿à®Ÿà¯à®Ÿà¯à®µà®¿à®Ÿà®¾à®¤à¯€à®°à¯à®•à®³à¯!",
                progressHeader: "à®®à¯à®©à¯à®©à¯‡à®±à¯à®±à®®à¯",
                welcomeTitle: "à®µà®¾à®°à¯à®™à¯à®•à®³à¯!",
                welcomeSubtitle: "à®ªà¯à®•à¯ˆà®ªà¯à®ªà®¿à®Ÿà®¿à®•à¯à®•à®¾à®¤ à®µà®¾à®´à¯à®•à¯à®•à¯ˆà®¯à¯ˆ à®¨à¯‹à®•à¯à®•à®¿à®¯ à®‰à®™à¯à®•à®³à¯ à®ªà®¯à®£à®¤à¯à®¤à¯ˆà®¤à¯ à®¤à¯Šà®Ÿà®™à¯à®•à¯à®µà¯‹à®®à¯.",
                initialCigarettesLabel: "à®¨à¯€à®™à¯à®•à®³à¯ à®’à®°à¯ à®¨à®¾à®³à¯ˆà®•à¯à®•à¯ à®à®¤à¯à®¤à®©à¯ˆ à®šà®¿à®•à®°à¯†à®Ÿà¯ à®ªà¯à®•à¯ˆà®ªà¯à®ªà¯€à®°à¯à®•à®³à¯?",
                startButton: "à®ªà®¯à®£à®¤à¯à®¤à¯ˆà®¤à¯ à®¤à¯Šà®Ÿà®™à¯à®•à¯",
                todaysTarget: "à®‡à®©à¯à®±à¯ˆà®¯ à®‡à®²à®•à¯à®•à¯",
                smokedToday: "à®‡à®©à¯à®±à¯ à®ªà¯à®•à¯ˆà®¤à¯à®¤à®¤à¯",
                smokedButton: "à®¨à®¾à®©à¯ à®’à®°à¯ à®šà®¿à®•à®°à¯†à®Ÿà¯ à®ªà¯à®•à¯ˆà®¤à¯à®¤à¯‡à®©à¯",
                progressLogTitle: "à®®à¯à®©à¯à®©à¯‡à®±à¯à®±à®ªà¯ à®ªà®¤à®¿à®µà¯‡à®Ÿà¯",
                dateHeader: "à®¤à¯‡à®¤à®¿",
                targetHeader: "à®‡à®²à®•à¯à®•à¯",
                smokedHeader: "à®ªà¯à®•à¯ˆà®¤à¯à®¤à®¤à¯",
                statusHeader: "à®¨à®¿à®²à¯ˆ"
            }
        };

        // --- Core App Functions ---
        function init() {
            loadState();
            updateUIForLanguage();
            if (state.plan && state.plan.length > 0) {
                 checkDailyStatus(); // Check status first
                 showAppreciationForYesterday(); // Then show appreciation if needed
                 const finalDay = state.plan[state.plan.length -1];
                 if(finalDay.target === 0 && finalDay.status === 'Pass'){
                     showScreen('congrats');
                 } else {
                     showScreen('main');
                     render();
                 }
            } else {
                showScreen('setup');
            }
            setupEventListeners();
        }
        
        function showScreen(screenName) {
            history.pushState({ screen: screenName }, '');
            setupScreen.classList.add('hidden');
            mainScreen.classList.add('hidden');
            congratsScreen.classList.add('hidden');
            startOverButton.classList.add('hidden');
            nextDayButton.classList.add('hidden');
            
            if(screenName === 'setup') {
                setupScreen.classList.remove('hidden');
            } else if(screenName === 'main' || screenName === 'congrats') {
                if(screenName === 'main') mainScreen.classList.remove('hidden');
                if(screenName === 'congrats') congratsScreen.classList.remove('hidden');
                startOverButton.classList.remove('hidden');
                nextDayButton.classList.remove('hidden');
                if (screenName === 'congrats') stopCountdown();
            }
        }

        function setupEventListeners() {
            window.addEventListener('popstate', handlePopState);
            setupForm.addEventListener('submit', startJourney);
            languageSwitcher.addEventListener('click', toggleLanguage);
            smokedButton.addEventListener('click', handleSmokedClick);
            urgeButton.addEventListener('click', showSosScreen);
            startOverButton.addEventListener('click', () => showConfirmModal('startOver'));
            document.getElementById('confirm-no-button').addEventListener('click', () => closeModal('confirm-modal'));
            document.getElementById('confirm-yes-button').addEventListener('click', resetJourney);
            nextDayButton.addEventListener('click', advanceDay);

            sosCloseButton.addEventListener('click', hideSosScreen);
            document.querySelectorAll('[data-sos]').forEach(btn => {
                if (btn.dataset.sos !== 'game') {
                    btn.addEventListener('click', () => handleSosChoice(btn.dataset.sos));
                }
            });
            document.getElementById('breathing-done-button').addEventListener('click', () => showSosView('menu'));
            document.getElementById('breathing-back-button').addEventListener('click', () => showSosView('menu'));
            document.getElementById('motivation-back-button').addEventListener('click', () => showSosView('menu'));
            document.getElementById('appreciation-close-button').addEventListener('click', () => closeModal('appreciation-modal'));
        }
        
        function generatePlan() { 
            state.plan = []; 
            let planDate = new Date();
            let dayCounter = 0; 
            while(true) { 
                const weekNumber = Math.floor(dayCounter / 7);
                const dailyTarget = Math.max(0, state.initialCount - weekNumber);
                state.plan.push({ date: toISODateString(planDate), target: dailyTarget, smoked: 0, status: 'Pending' }); 
                if (dailyTarget === 0) break; 
                planDate.setDate(planDate.getDate() + 1); 
                dayCounter++; 
            } 
        }

        function renderDashboard() { 
            const todayEntry = getTodayEntry(); 
            if (todayEntry) { 
                targetCountEl.textContent = todayEntry.target; 
                smokedCountEl.textContent = todayEntry.smoked; 
                const { smoked, target } = todayEntry; 
                smokedCountEl.classList.remove('text-green-500', 'text-amber-500', 'text-red-500', 'text-slate-800'); 
                if (smoked <= target) {
                    smokedCountEl.classList.add('text-slate-800');
                } else {
                    smokedCountEl.classList.add('text-red-500');
                }
                if (smoked >= target) { 
                    smokedButton.classList.add('hidden'); 
                    limitReachedControls.classList.remove('hidden'); 
                    limitReachedButton.innerHTML = (translations[state.language] && translations[state.language].limitReachedText) || ''; 
                    startCountdown(); 
                } else { 
                    smokedButton.classList.remove('hidden'); 
                    limitReachedControls.classList.add('hidden'); 
                    stopCountdown(); 
                } 
            } else { 
                targetCountEl.textContent = '0'; 
                smokedCountEl.textContent = '0'; 
                smokedButton.classList.add('hidden'); 
            } 
        }

        function showSosScreen() { 
            history.pushState({ screen: 'sos' }, '');
            sosScreen.classList.remove('hidden'); 
            sosScreen.classList.add('flex'); 
            showSosView('menu'); 
        }
        
        function hideSosScreen() { 
            history.pushState({ screen: 'main' }, '');
            sosScreen.classList.add('hidden'); 
            sosScreen.classList.remove('flex'); 
            stopBreathingExercise(); 
        }
        function handleSosChoice(choice) { showSosView(choice); }
        
        function showNextMotivation() {
            const quotes = translations[state.language]?.motivationQuotes;
            if (!quotes) return;
            let randomIndex;
            do { randomIndex = Math.floor(Math.random() * quotes.length); } while (quotes.length > 1 && randomIndex === lastMotivationQuoteIndex);
            lastMotivationQuoteIndex = randomIndex;
            motivationQuoteText.textContent = `"${quotes[randomIndex]}"`;
        }

        function showSosView(viewName) {
            history.pushState({ screen: 'sos-' + viewName }, '');
            sosMenu.classList.add('hidden');
            sosBreathingView.classList.add('hidden');
            sosMotivationView.classList.add('hidden');

            const breathingView = document.getElementById('sos-breathing-view');
            breathingView.classList.remove('active');

            if(breathingIntervals.length > 0) stopBreathingExercise();

            if (viewName === 'menu') {
                sosMenu.classList.remove('hidden');
            } else if (viewName === 'breathing') {
                sosBreathingView.classList.remove('hidden');
                startBreathingExercise();
            } else if (viewName === 'motivation') { 
                sosMotivationView.classList.remove('hidden');
                showNextMotivation();
            }
        }
        
        function startBreathingExercise() {
            const breathingView = document.getElementById('sos-breathing-view');
            breathingView.classList.add('active'); // Activate dark theme

            breathingAnimationView.style.display = 'flex';
            breathingCompleteView.style.display = 'none';

            const outerRing = document.getElementById('breathing-outer-ring');
            const innerCircle = document.getElementById('breathing-inner-circle');
            const instruction = document.getElementById('breathing-instruction');
            const mainTimerEl = document.getElementById('breathing-main-timer');

            const phases = [
                { text: "Breathe In", scale: 1, duration: 4000 },
                { text: "Hold", scale: 1, duration: 4000 },
                { text: "Breathe Out", scale: 0.75, duration: 6000 }
            ];
            let currentPhase = -1;
            let mainTimer = 120;
            mainTimerEl.textContent = mainTimer;

            function nextPhase() {
                instruction.classList.remove('visible');

                setTimeout(() => {
                    currentPhase = (currentPhase + 1) % phases.length;
                    const phase = phases[currentPhase];
                    
                    instruction.textContent = phase.text;
                    instruction.classList.add('visible');
                    
                    outerRing.style.transform = `scale(${phase.scale})`;
                    innerCircle.style.transform = `scale(${phase.scale})`;

                    const phaseTimer = setTimeout(nextPhase, phase.duration);
                    breathingIntervals.push(phaseTimer);
                }, 1000); // 1s pause between phases
            }
            
            const mainTimerInterval = setInterval(() => {
                mainTimer--;
                mainTimerEl.textContent = mainTimer;
                if(mainTimer <= 0) clearInterval(mainTimerInterval);
            }, 1000);
            breathingIntervals.push(mainTimerInterval);

            nextPhase();

            const mainTimeout = setTimeout(() => {
                stopBreathingExercise(true);
            }, 120000); 
            breathingIntervals.push(mainTimeout);
        }
        
        function stopBreathingExercise(isComplete = false) {
            breathingIntervals.forEach(id => { clearTimeout(id); clearInterval(id); });
            breathingIntervals = [];

            const breathingView = document.getElementById('sos-breathing-view');
            if (isComplete) {
                breathingView.classList.add('active'); // Keep dark theme for complete message
                breathingAnimationView.style.display = 'none';
                breathingCompleteView.style.display = 'flex';
            } else {
                 breathingView.classList.remove('active');
            }
        }

        function getCurrentDate() { return mockDate || new Date(); }
        function getTodayEntry() { return state.plan ? state.plan.find(day => day.date === toISODateString(getCurrentDate())) : null; }
        function toISODateString(date) { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function formatDate(dateString) { const date = new Date(dateString); const options = { month: 'short', day: 'numeric', timeZone: 'UTC' }; return date.toLocaleDateString(state.language === 'ta' ? 'ta-IN' : 'en-US', options); }
        
        function resetJourney() { 
            closeModal('confirm-modal');
            localStorage.removeItem('smokeFreeJourneyState'); 
            localStorage.removeItem('smokeFreeMockDate');
            mockDate = null;
            state = {}; 
            // Instead of reloading, we re-initialize the app's logic
                      init(); 

        }

        function showConfirmModal(type) { 
            const confirmTitle = document.getElementById('confirm-modal-title');
            const confirmText = document.getElementById('confirm-modal-text');
            if (type === 'startOver') { 
                confirmTitle.textContent = (translations[state.language] && translations[state.language].confirmStartOverTitle) || "Start Over?"; 
                confirmText.textContent = (translations[state.language] && translations[state.language].confirmStartOverText) || "All your progress will be lost."; 
            } 
            confirmModal.classList.remove('hidden'); 
            confirmModal.querySelector('.modal-content').classList.add('scale-100'); 
        }
        function closeModal(modalId) { const modal = document.getElementById(modalId); modal.querySelector('.modal-content').classList.remove('scale-100'); modal.classList.add('hidden'); }
        function saveState() { localStorage.setItem('smokeFreeJourneyState', JSON.stringify(state)); }
        
        function loadState() {
            let loadedState = {};
            const savedState = localStorage.getItem('smokeFreeJourneyState');
            if (savedState) {
                try {
                    loadedState = JSON.parse(savedState);
                } catch (e) {
                    console.error("Failed to parse state from localStorage, starting fresh.", e);
                    loadedState = {};
                }
            }
            
            const defaultState = { language: 'en', plan: [], startDate: null, initialCount: 0, lastCheckedDate: null };
            state = { ...defaultState, ...loadedState };

            const savedMockDate = localStorage.getItem('smokeFreeMockDate');
            if (savedMockDate) {
                mockDate = new Date(savedMockDate);
            }
        }

        function render() { renderDashboard(); renderTable(); }
        
        function renderTable() {
            progressTableBody.innerHTML = '';
            const todayStr = toISODateString(getCurrentDate());
            if (!state.plan) return;
            state.plan.forEach((day, index) => {
                const isToday = day.date === todayStr;
                const rowClass = isToday ? 'bg-slate-100 font-semibold' : '';
                let statusClass = '';
                let statusText = 'Pending';
                if (day.status === 'Pass') {
                    statusClass = 'text-green-500';
                    statusText = 'Pass';
                } else if (day.status === 'Fail') {
                    statusClass = 'text-red-500';
                    statusText = 'Fail';
                } else if (day.status === 'Waiting') {
                    statusClass = 'text-amber-500';
                    statusText = 'Wait';
                } else if (day.status === 'Over') {
                    statusClass = 'text-blue-500';
                    statusText = 'Over';
                }

                let progressCellContent = '-'; 
                if (day.date < todayStr) { 
                    const weekNumber = Math.floor(index / 7);
                    let progress = 0;
                    if (state.initialCount > 0) {
                        progress = Math.min(100, Math.round(((weekNumber) / state.initialCount) * 100) + 10);
                    } else if (day.target === 0) {
                        progress = 100;
                    }
                    progressCellContent = `<span class="font-semibold text-cyan-600">${progress}%</span>`;
                }

                const row = `<tr class="${rowClass}">
                    <td class="py-3 px-2">${formatDate(day.date)}</td>
                    <td class="py-3 px-2 text-center">${day.target}</td>
                    <td class="py-3 px-2 text-center">${day.smoked}</td>
                    <td class="py-3 px-2 text-center font-semibold ${statusClass}">${statusText}</td>
                    <td class="py-3 px-2 text-center">${progressCellContent}</td>
                </tr>`;
                progressTableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        function startCountdown() { 
            if (countdownInterval) clearInterval(countdownInterval); 
            countdownInterval = setInterval(() => { 
                const now = getCurrentDate(); 
                const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0); 
                const diff = midnight - now; 
                if (diff <= 1000) { 
                    stopCountdown(); 
                    if (mockDate) { localStorage.removeItem('smokeFreeMockDate'); }
                    setTimeout(() => location.reload(), 1000); 
                    return; 
                } 
                const hours = String(Math.floor((diff / (1000 * 60 * 60)) % 24)).padStart(2, '0'); 
                const minutes = String(Math.floor((diff / 1000 / 60) % 60)).padStart(2, '0'); 
                const seconds = String(Math.floor((diff / 1000) % 60)).padStart(2, '0'); 
                const countdownSpan = document.getElementById('countdown-timer'); 
                if (countdownSpan) { 
                    countdownSpan.textContent = `${hours}:${minutes}:${seconds}`; 
                } 
            }, 1000); 
        }

        function stopCountdown() { if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; } }
        
        function updateUIForLanguage() { 
            languageSwitcher.textContent = state.language === 'en' ? 'à®¤à®®à®¿à®´à¯' : 'English'; 
            document.querySelectorAll('[data-translate]').forEach(el => { 
                const key = el.getAttribute('data-translate'); 
                if (translations[state.language] && translations[state.language][key]) { 
                    el.innerHTML = translations[state.language][key]; 
                } 
            }); 
        }
        
        function checkDailyStatus() {
            const todayStr = toISODateString(getCurrentDate());
            if(!state.plan || !state.lastCheckedDate || state.lastCheckedDate === todayStr) return;
            state.plan.forEach(day => {
                if (day.date < todayStr && (day.status === 'Pending' || day.status === 'Waiting' || day.status === 'Over')) {
                    day.status = day.smoked <= day.target ? 'Pass' : 'Fail';
                }
            });
            state.lastCheckedDate = todayStr;
            saveState();
            renderTable();
        }
        
        function handleSmokedClick() {
            const todayEntry = getTodayEntry();
            if (todayEntry) {
                todayEntry.smoked += 1;
                
                if (todayEntry.smoked === todayEntry.target) {
                    todayEntry.status = 'Over';
                } else if (todayEntry.smoked > todayEntry.target) {
                    todayEntry.status = 'Waiting';
                }

                saveState();
                render();
            }
        }

        function startJourney(e) {
            e.preventDefault();
            const count = parseInt(initialCigarettesInput.value);
            if (count > 0) {
                state.initialCount = count;
                state.startDate = toISODateString(getCurrentDate());
                state.lastCheckedDate = toISODateString(new Date(getCurrentDate().setDate(getCurrentDate().getDate()-1)));
                generatePlan();
                saveState();
                showScreen('main');
                render();
            }
        }
        
        function toggleLanguage() {
            state.language = state.language === 'en' ? 'ta' : 'en';
            saveState();
            updateUIForLanguage();
            if (state.plan && state.plan.length > 0) {
                render(); 
            }
        }

        function advanceDay() {
            if (!mockDate) {
                mockDate = new Date();
            }
            mockDate.setDate(mockDate.getDate() + 1);
            localStorage.setItem('smokeFreeMockDate', mockDate.toISOString());
            location.reload();
        }

        function handlePopState(event) {
            if (event.state && event.state.screen) {
                const screen = event.state.screen;
                if (screen.startsWith('sos-')) {
                    hideSosScreen();
                    showSosScreen(); 
                } else if (screen === 'sos') {
                    showSosScreen();
                } else {
                    hideSosScreen();
                    showScreen(screen);
                }
            } else {
                hideSosScreen();
            }
        }

        // NEW: Function to show appreciation message
        function showAppreciationForYesterday() {
            const yesterday = new Date(getCurrentDate());
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = toISODateString(yesterday);

            const lastAppreciationDate = localStorage.getItem('lastAppreciationDate');
            if (lastAppreciationDate === yesterdayStr) {
                return; // Already shown for this date
            }

            const yesterdayEntry = state.plan.find(day => day.date === yesterdayStr);
            if (yesterdayEntry && yesterdayEntry.status === 'Pass') {
                const messages = translations[state.language]?.appreciationMessages;
                if (messages) {
                    const message = messages[Math.floor(Math.random() * messages.length)];
                    document.getElementById('appreciation-modal-text').textContent = message;
                    appreciationModal.classList.remove('hidden');
                    appreciationModal.querySelector('.modal-content').classList.add('scale-100');
                    localStorage.setItem('lastAppreciationDate', yesterdayStr);
                }
            }
        }

        init();
    </script>
</body>
</html>


